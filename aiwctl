#!/usr/bin/env bash
# =========================================================
# aiwctl - NVIDIA AI Workbench Control Utility (Omarchy / Arch)
# Author: Rob Jackson (auto-generated by ChatGPT)
# =========================================================

set -e
VERSION="1.0.0"
APPIMAGE_URL="https://developer.download.nvidia.com/ai-workbench/ai-workbench-latest-x86_64.AppImage"
APPIMAGE_PATH="/usr/local/bin/ai-workbench"

banner() {
  echo "========================================================"
  echo "üß† NVIDIA AI Workbench Control (aiwctl v$VERSION)"
  echo "========================================================"
}

install_aiw() {
  banner
  echo "üîÑ Updating system packages..."
  sudo pacman -Syu --noconfirm

  echo "üß© Installing NVIDIA drivers and CUDA..."
  sudo pacman -S --noconfirm nvidia nvidia-utils nvidia-settings cuda cudnn

  echo "üê≥ Installing Docker..."
  sudo pacman -S --noconfirm docker
  sudo systemctl enable --now docker
  sudo usermod -aG docker "$USER"

  echo "üß∞ Installing NVIDIA Container Toolkit..."
  curl -s -L https://nvidia.github.io/libnvidia-container/gpgkey | sudo pacman-key --add -
  curl -s -L https://nvidia.github.io/libnvidia-container/archlinux/libnvidia-container.repo | sudo tee /etc/pacman.d/libnvidia-container.repo
  sudo pacman -Syu --noconfirm nvidia-container-toolkit
  sudo nvidia-ctk runtime configure --runtime=docker
  sudo systemctl restart docker

  echo "üì¶ Downloading AI Workbench AppImage..."
  wget -O ~/Downloads/ai-workbench.AppImage "$APPIMAGE_URL"
  chmod +x ~/Downloads/ai-workbench.AppImage
  sudo mv ~/Downloads/ai-workbench.AppImage "$APPIMAGE_PATH"

  echo "üß™ Testing GPU access inside Docker..."
  docker run --rm --gpus all nvidia/cuda:12.2.0-base nvidia-smi || {
    echo "‚ö†Ô∏è GPU test failed ‚Äî check Docker GPU runtime setup."
    exit 1
  }

  echo "‚úÖ Installation complete!"
  echo "üöÄ Run 'ai-workbench' to launch the app."
}

uninstall_aiw() {
  banner
  echo "‚õî Uninstalling AI Workbench..."
  sudo systemctl stop docker || true
  sudo rm -f "$APPIMAGE_PATH"
  sudo pacman -Rns --noconfirm nvidia-container-toolkit docker || true
  sudo rm -f /etc/pacman.d/libnvidia-container.repo || true
  sudo rm -rf /var/lib/docker /etc/docker ~/.cache/ai-workbench ~/.local/share/ai-workbench || true

  read -rp "Remove CUDA + NVIDIA drivers too? [y/N]: " CONFIRM
  if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    sudo pacman -Rns --noconfirm nvidia nvidia-utils nvidia-settings cuda cudnn || true
  fi
  echo "üßº Cleanup complete."
}

update_aiw() {
  banner
  echo "‚¨ÜÔ∏è Updating AI Workbench AppImage..."
  wget -O ~/Downloads/ai-workbench.AppImage "$APPIMAGE_URL"
  chmod +x ~/Downloads/ai-workbench.AppImage
  sudo mv ~/Downloads/ai-workbench.AppImage "$APPIMAGE_PATH"
  echo "‚úÖ Updated to latest version."
}

test_gpu() {
  banner
  echo "üß† Running GPU diagnostic..."
  nvidia-smi || { echo "‚ùå GPU not detected."; exit 1; }
  echo "üê≥ Checking Docker GPU runtime..."
  docker run --rm --gpus all nvidia/cuda:12.2.0-base nvidia-smi
  echo "‚úÖ GPU and Docker integration verified."
}

show_help() {
  banner
  echo "Usage: aiwctl [command]"
  echo
  echo "Commands:"
  echo "  install     Install NVIDIA AI Workbench"
  echo "  uninstall   Uninstall Workbench and components"
  echo "  update      Update Workbench AppImage"
  echo "  test-gpu    Verify GPU + Docker setup"
  echo "  help        Show this help message"
  echo
}

case "$1" in
  install) install_aiw ;;
  uninstall) uninstall_aiw ;;
  update) update_aiw ;;
  test-gpu) test_gpu ;;
  help|--help|-h|"") show_help ;;
  *) echo "‚ùå Unknown command: $1"; show_help ;;
esac
